<!DOCTYPE html>
<html>
<head hexo-theme='https://volantis.js.org/#2.6.3'>
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
    
  
  <!-- 渲染优化 -->
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- 页面元数据 -->
  
    <title>量化定投，工薪族逆袭之路 - HiCoder</title>
  
    <meta name="keywords" content="量化,python">
  
  
    <meta name="description" content="

一个人一生能积累多少钱，不是取决于他能够赚多少钱，而是取决于他如何投资理财，人找钱不如钱找钱，要知道让钱为你工作，而不是你为钱工作。——（美）沃伦●巴菲特
">
  

  <!-- feed -->
  

  <!-- import meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13/css/all.min.css">
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">

  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/keyboard1.ico">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  

  <!-- import link -->
  

  
  
    
<link rel="stylesheet" href="/css/style.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>
<header class="l_header shadow blur">
  <div class='container'>
  <div class='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h'>
        <li><a class="s-comment fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li><a class="s-toc fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      
        
        <a class="title flat-box" target="_self" href='/'>
          
          
          
            Hi Coder
          
          
        </a>
      

			<div class='menu navigation'>
				<ul class='nav-list-h'>
          
          
          
            
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-rss-square fa-fw'></i>动态
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="flat-box" href=/2020/05/03/HiCoder%E4%B8%8A%E7%BA%BF%E5%95%A6/
                  
                  
                  
                    id="20200503HiCoderE4B88AE7BABFE595A6"
                  >
                  HiCoder 上线啦
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="flat-box" href=/code/
                  
                  
                  
                    id="code"
                  >
                  课程代码在线查看功能已上线
                </a>
                
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-desktop fa-fw'></i>课程
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="flat-box" href=https://study.163.com/course/courseMain.htm?share=2&amp;shareId=480000001896591&amp;courseId=1209189848&amp;_trace_c_p_k2_=66d1f2fe4d2544098bade8a3edaa23d3
                  
                  
                  
                    id="https:study163comcoursecourseMainhtm?share=2&amp;shareId=480000001896591&amp;courseId=1209189848&amp;_trace_c_p_k2_=66d1f2fe4d2544098bade8a3edaa23d3"
                  >
                  量化投资入门指南
                </a>
                
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 小白入门
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 进阶实战
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 爬虫实战
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 数据分析
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 网站开发
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 桌面应用开发
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 机器学习
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 深度学习
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 量化交易
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-book fa-fw'></i>文档
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li class='header'>
                python 爬虫实战
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 数据分析
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-code fa-fw'></i>代码
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="flat-box" href=https://github.com/mrshiqiqi/QuantGuide
                  
                  
                  
                    id="https:githubcommrshiqiqiQuantGuide"
                  >
                  量化投资入门指南
                </a>
                
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 小白入门
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box">
                  <i class='fas fa-compact-disc fa-fw music'></i>背景音乐
                </a>
                <ul class="list-v">
                  <li>
                    <div class="aplayer-container">
                      

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='340px'
      server='netease'
      type='playlist'
      id='3175833810'
      list-folded='true'>
    </meting-js>
  


                    </div>
                  </li>
                </ul>
              <li>
            
          
          
            
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-angle-double-right fa-fw'></i>更多
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li class='header'>
                反馈建议
              </li>
            
          
                    
                      
            
              <li class='header'>
                联系作者
              </li>
            
          
                    
                      
            
              <li class='header'>
                捐助
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
          
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>

			<ul class='switcher nav-list-h'>
				
					<li><a class="s-search fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li>
          <a class="s-menu fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-rss-square fa-fw'></i>动态
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="flat-box" href=/2020/05/03/HiCoder%E4%B8%8A%E7%BA%BF%E5%95%A6/
                  
                  
                  
                    id="20200503HiCoderE4B88AE7BABFE595A6"
                  >
                  HiCoder 上线啦
                </a>
                
              </li>
            
          
                    
                      
            
              <li>
                <a class="flat-box" href=/code/
                  
                  
                  
                    id="code"
                  >
                  课程代码在线查看功能已上线
                </a>
                
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-desktop fa-fw'></i>课程
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="flat-box" href=https://study.163.com/course/courseMain.htm?share=2&amp;shareId=480000001896591&amp;courseId=1209189848&amp;_trace_c_p_k2_=66d1f2fe4d2544098bade8a3edaa23d3
                  
                  
                  
                    id="https:study163comcoursecourseMainhtm?share=2&amp;shareId=480000001896591&amp;courseId=1209189848&amp;_trace_c_p_k2_=66d1f2fe4d2544098bade8a3edaa23d3"
                  >
                  量化投资入门指南
                </a>
                
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 小白入门
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 进阶实战
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 爬虫实战
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 数据分析
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 网站开发
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 桌面应用开发
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 机器学习
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 深度学习
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 量化交易
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-book fa-fw'></i>文档
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li class='header'>
                python 爬虫实战
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 数据分析
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-code fa-fw'></i>代码
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li>
                <a class="flat-box" href=https://github.com/mrshiqiqi/QuantGuide
                  
                  
                  
                    id="https:githubcommrshiqiqiQuantGuide"
                  >
                  量化投资入门指南
                </a>
                
              </li>
            
          
                    
                      
            
              <li class='header'>
                python 小白入门
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box">
                  <i class='fas fa-compact-disc fa-fw music'></i>背景音乐
                </a>
                <ul class="list-v">
                  <li>
                    <div class="aplayer-container">
                      

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='340px'
      server='netease'
      type='playlist'
      id='3175833810'
      list-folded='true'>
    </meting-js>
  


                    </div>
                  </li>
                </ul>
              <li>
            
          
            
              
            
              <li>
                <a class="flat-box" href=/about/
                  
                  
                  
                    id="about"
                  >
                  <i class='fas fa-info-circle fa-fw'></i>关于
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="flat-box" 
                  
                  
                  >
                  <i class='fas fa-angle-double-right fa-fw'></i>更多
                </a>
                
                  <ul class="list-v">
                    
                      
            
              <li class='header'>
                反馈建议
              </li>
            
          
                    
                      
            
              <li class='header'>
                联系作者
              </li>
            
          
                    
                      
            
              <li class='header'>
                捐助
              </li>
            
          
                    
                  </ul>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>
		</div>
	</div>
  </div>
</header>

<script>setLoadingBarProgress(40);</script>



  <div class="l_body nocover">
    <div class='body-wrapper'>
      

<div class='l_main'>
  

  
    <article id="post" class="post white-box reveal shadow article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
      
      
        <a title='量化定投，工薪族逆袭之路' href='/2020/05/04/%E9%87%8F%E5%8C%96%E5%AE%9A%E6%8A%95%EF%BC%8C%E5%B7%A5%E8%96%AA%E6%97%8F%E9%80%86%E8%A2%AD%E4%B9%8B%E8%B7%AF/'><img class='thumbnail' src='https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/thumbnail_line_chart.ico'></a>
      
      <div class="meta" id="header-meta">
        
          
  <h1 class="title">
    <a href="/2020/05/04/%E9%87%8F%E5%8C%96%E5%AE%9A%E6%8A%95%EF%BC%8C%E5%B7%A5%E8%96%AA%E6%97%8F%E9%80%86%E8%A2%AD%E4%B9%8B%E8%B7%AF/">
      量化定投，工薪族逆袭之路
    </a>
  </h1>


        
        <div class='new-meta-box'>
          
            
          
            
              
<div class='new-meta-item author'>
  <a href="hicoder.com.cn" rel="nofollow">
    <img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/aboutme.jpg">
    <p>大树</p>
  </a>
</div>

            
          
            
              
  
  <div class='new-meta-item category'>
    <a href='/categories/python/%E9%87%8F%E5%8C%96/' rel="nofollow">
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
      <p>python/量化</p>
    </a>
  </div>


            
          
            
              <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：May 4, 2020</p>
  </a>
</div>

            
          
            
              

            
          
        </div>
        
          <hr>
        
      </div>
    
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <p><img src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1588578534929&di=510f0273873d8db6b58502f42b3d4022&imgtype=0&src=http%3A%2F%2Fgbres.dfcfw.com%2Ffiles%2Fpicture%2F20190829%2F91bfb5999ea82729dbdaf5752b9ab31e_w1267h527.png" alt=""></p>
<blockquote>
<p>一个人一生能积累多少钱，不是取决于他能够赚多少钱，而是取决于他如何投资理财，人找钱不如钱找钱，要知道让钱为你工作，而不是你为钱工作。——（美）沃伦●巴菲特</p>
</blockquote>
<a id="more"></a>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入常用的库</span></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd </span><br><span class="line"><span class="keyword">import</span> datetime <span class="keyword">as</span> dt</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">from</span> jqdata <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> tushare <span class="keyword">as</span> ts</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line">plt.style.use(<span class="string">'fivethirtyeight'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="一、指数格局，跌宕起伏"><a href="#一、指数格局，跌宕起伏" class="headerlink" title="一、指数格局，跌宕起伏"></a>一、指数格局，跌宕起伏</h2><p>这里的指数，我们重点说一下上证指数、深圳指数。指数其实是一篮子股票，它反应的这些股票总体的表现。而上证与深圳指数更反应出当下国内的经济形式（当然不是百分百的呈现）。</p>
<p>相信大家都了解过经济周期，理论上，社会环境的经济会以<strong>衰退－萧条－复苏－繁荣</strong>四种形式往复呈现。不过，由于不同国家的国情不尽相同，这种周而复始的周期曲线表现得并不完美。</p>
<p>下图为经济周期曲线图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_%E7%BB%8F%E6%B5%8E%E5%91%A8%E6%9C%9F.png" alt=""></p>
<p>那么，股市是否也会呈现一定的周期性呢？如果具有周期性，如何估算牛熊之间的时间距离呢？带着这样的疑问，接着往下探究。</p>
<p>在探究此问题之前，可以去查找一下相关的历史资料，看看是否有人已经给出答案，或者可以找一些重要的线索。经过百度，收集到：上证指数<strong>1990年12月19号</strong>成立，之后的经历了<strong>4次</strong>牛市，分别<strong>1993年2月、2001年6月、2007年10月、2015年6月</strong>。让我们来实际看一下上证指数全部的趋势情况。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">plt.style.use(<span class="string">'fivethirtyeight'</span>)</span><br><span class="line"><span class="comment"># 由于数据量比较多，这里打算从 tushare 获取上证指数所有的价格数据</span></span><br><span class="line"><span class="comment"># tushare 接口，参数为注册时生成的 token</span></span><br><span class="line">pro = ts.pro_api(<span class="string">'xxxxxxxxx'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># tushare 要求一次最多获取 3000 条数据，所以分两次获取</span></span><br><span class="line"><span class="comment"># 然后将数据合并，按时间排序</span></span><br><span class="line">df1 = pro.index_daily(ts_code=<span class="string">'000001.SH'</span>, </span><br><span class="line">                      start_date=<span class="string">'19901219'</span>, </span><br><span class="line">                      end_date=<span class="string">'20101231'</span>)</span><br><span class="line">df2 = pro.index_daily(ts_code=<span class="string">'000001.SH'</span>, </span><br><span class="line">                      start_date=<span class="string">'20110101'</span>, </span><br><span class="line">                      end_date=<span class="string">'20190630'</span>)</span><br><span class="line">df = pd.concat([df2, df1])  <span class="comment"># 合并</span></span><br><span class="line">df = df.sort_values(by=[<span class="string">'trade_date'</span>])  <span class="comment"># 排序</span></span><br><span class="line">df[<span class="string">'trade_date'</span>] = pd.to_datetime(df[<span class="string">'trade_date'</span>])  <span class="comment"># 转换为时间类型</span></span><br><span class="line">df.set_index([<span class="string">'trade_date'</span>], inplace=<span class="literal">True</span>)  <span class="comment"># 设置索引列</span></span><br><span class="line">df.index.name = <span class="literal">None</span>  <span class="comment"># 去掉索引列名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将上证指数价格曲线画出来</span></span><br><span class="line"><span class="comment"># 并在对应的牛市年份，画一条竖线来标记</span></span><br><span class="line">df.close.plot(figsize=(<span class="number">14</span>, <span class="number">7</span>), title=<span class="string">'牛顶间隔展示'</span>)</span><br><span class="line"><span class="keyword">for</span> year <span class="keyword">in</span> [<span class="string">'1993-02-01'</span>, <span class="string">'2001-06-01'</span>, </span><br><span class="line">             <span class="string">'2007-10-01'</span>, <span class="string">'2015-06-01'</span>]:</span><br><span class="line">    plt.axvline(year,color=<span class="string">'r'</span>, alpha=<span class="number">0.7</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_3_0.png" alt=""></p>
<p>看完这张图，大概大家都会感慨：曾经的股市是多么的疯狂，它也像人生，起起伏伏。粗一看，感觉指数的起伏是有一定的周期性规律可寻的，但仔细看却发现，各牛市间的时间间隔并不匀称。那问题来了，各牛市顶点的时间间隔大概在什么样的取值范围呢？未来大盘的趋势是否会符合某种规律呢？接下来我们计算一下各牛顶时间节点的平均间隔时间与偏差。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 转换成时间格式</span></span><br><span class="line">best_years = [dt.datetime.strptime(year, <span class="string">'%Y-%m-%d'</span>).date() </span><br><span class="line">              <span class="keyword">for</span> year <span class="keyword">in</span> [<span class="string">'1993-02-01'</span>, <span class="string">'2001-06-01'</span>, </span><br><span class="line">                           <span class="string">'2007-10-01'</span>, <span class="string">'2015-06-01'</span>]]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算牛顶时间间隔</span></span><br><span class="line">gap_year = [days.days <span class="keyword">for</span> days <span class="keyword">in</span> np.diff(best_years)]</span><br><span class="line">print(<span class="string">'牛顶平均间隔时间：'</span>, [<span class="string">'&#123;&#125; days'</span>.format(days) <span class="keyword">for</span> days <span class="keyword">in</span> gap_year])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算平均间隔年数，为避免盲目猜测，再计算出均值的偏差值</span></span><br><span class="line">mean_gap = np.mean(gap_year)</span><br><span class="line">print(<span class="string">'平均时间间隔 &#123;&#125; 天，即 &#123;&#125; 年'</span>.format(round(mean_gap, <span class="number">2</span>), round(mean_gap / <span class="number">365</span>, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算平均时间间隔偏差值</span></span><br><span class="line">std_gap = np.std(gap_year)</span><br><span class="line">print(<span class="string">'平均时间间隔偏差 &#123;&#125; 天，即 &#123;&#125; 年'</span>.format(round(std_gap, <span class="number">2</span>), round(std_gap / <span class="number">365</span>, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算下一个牛市出现的合理时间区间</span></span><br><span class="line">early_year = (best_years[<span class="number">-1</span>] + dt.timedelta(round(mean_gap - std_gap, <span class="number">0</span>)))</span><br><span class="line">latest_year = (best_years[<span class="number">-1</span>] + dt.timedelta(round(mean_gap + std_gap, <span class="number">0</span>)))</span><br><span class="line"><span class="comment"># 构造 title</span></span><br><span class="line">early_y = early_year.year</span><br><span class="line">early_m = early_year.month</span><br><span class="line">latest_y = latest_year.year</span><br><span class="line">latest_m = latest_year.month</span><br><span class="line">print(<span class="string">'下个牛顶时间范围 &#123;&#125;年&#123;&#125;月 ~ &#123;&#125;年&#123;&#125;月'</span>.format(early_y, early_m, latest_y, latest_m))</span><br></pre></td></tr></table></figure>

<pre><code>牛顶平均间隔时间： [&apos;3042 days&apos;, &apos;2313 days&apos;, &apos;2800 days&apos;]
平均时间间隔 2718.33 天，即 7.45 年
平均时间间隔偏差 303.16 天，即 0.83 年
下个牛顶时间范围 2022年1月 ~ 2023年9月</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">title = <span class="string">'评估下个牛顶时间范围 &#123;&#125;年&#123;&#125;月 ~ &#123;&#125;年&#123;&#125;月'</span>.format(early_y, early_m, latest_y, latest_m)</span><br><span class="line">df.close.plot(figsize=(<span class="number">14</span>, <span class="number">7</span>), title=title)</span><br><span class="line"><span class="keyword">for</span> year <span class="keyword">in</span> [<span class="string">'1993-02-01'</span>, <span class="string">'2001-06-01'</span>, </span><br><span class="line">             <span class="string">'2007-10-01'</span>, <span class="string">'2015-06-01'</span>]:</span><br><span class="line">    plt.axvline(year,color=<span class="string">'r'</span>, alpha=<span class="number">0.6</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 生成 2019-02-11 ~ 2023-12-10 的时间区间</span></span><br><span class="line"><span class="comment"># 如果要填充一个区间，y 就给价格的最大值便好</span></span><br><span class="line">date_span = pd.date_range(early_year, latest_year)</span><br><span class="line">value_span = [df.close.max() <span class="keyword">for</span> x <span class="keyword">in</span> date_span]</span><br><span class="line">plt.fill_between(date_span, value_span, color=<span class="string">'orange'</span>, alpha=<span class="number">0.8</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_6_0.png" alt=""></p>
<p>这里需要提醒一下大家：历史数据只可用来评估一些现象，但绝不能 100% 预言未来！所以大家还要带着辩证的心态看待这个结果。</p>
<p><strong>通过上面的统计与可视化，可得出以下结论：</strong></p>
<ol>
<li>一轮牛熊的平均时间间隔为7.5年左右；</li>
<li>4轮牛熊的时间偏差在0.8年左右；</li>
<li>依此估算的下个牛顶的时间范围在2022年1月 ~ 2023年9月之间。</li>
</ol>
<p>假设这个结果是大概率可信的，那在到达牛顶之前，一定要经过一个牛市的启动阶段——所以，低估值与熊之尾巴才是最宝贵的！！！</p>
<h2 id="二、定投畅想，看好国运"><a href="#二、定投畅想，看好国运" class="headerlink" title="二、定投畅想，看好国运"></a>二、定投畅想，看好国运</h2><p>指数的价格一直在波动起伏，但从宏观看来，其底部是一直在抬高的。只要国家经济一直是向好的，那指数的从超长期来看，是总体向上发展的。<strong>也就是说，买指数产品，就是看好国运！</strong></p>
<p>例如下图，通过线性回归，我们可以看出，上证指数的价格整体趋势是向上的。假如在上证指数成立之初我们就买入，并一直持有到现在，到目前为止的收益将是多少呢？我们来做个计算。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过线性回归，刻画整体平均趋势</span></span><br><span class="line">plt.figure(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">sns.regplot(x=np.arange(<span class="number">0</span>, df.shape[<span class="number">0</span>]), y=df.close.values)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_9_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 为了计算方便，默认都倩收盘价格为准</span></span><br><span class="line"><span class="comment"># 获取上市第一天的收盘价和当前收盘价</span></span><br><span class="line">start_price = df.close[<span class="number">0</span>]</span><br><span class="line">end_price = df.close[<span class="number">-1</span>]</span><br><span class="line">print(<span class="string">'最初收盘价为 &#123;&#125;，当前收盘价为 &#123;&#125;'</span>.format(start_price, end_price))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算收益率</span></span><br><span class="line">total_return = (end_price / start_price) - <span class="number">1</span></span><br><span class="line">print(<span class="string">'持有到目前为止的收益率为 &#123;&#125;%'</span>.format(round(total_return * <span class="number">100</span>, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算年平均收益，一年以250个交易日为准</span></span><br><span class="line"><span class="comment"># 平均年化收益率=(投资内收益/本金)×（250/投资天数）× 100%</span></span><br><span class="line">mean_return = total_return * (<span class="number">250</span> / df.shape[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">'平均每年收益率为 &#123;&#125;%'</span>.format(round(mean_return * <span class="number">100</span>, <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算年化收益率复利</span></span><br><span class="line"><span class="comment"># 本息和 = 本金 * （年化利率 + 1）的 n 次方，n为交易年数</span></span><br><span class="line"><span class="comment"># 年化利率 = （本息和 / 本金）的 n次开根 - 1</span></span><br><span class="line">annualized_return = pow((end_price / start_price), <span class="number">1</span> / (df.shape[<span class="number">0</span>] / <span class="number">250</span>)) - <span class="number">1</span></span><br><span class="line">print(<span class="string">'年化收益率为 &#123;&#125;%'</span>.format(round(annualized_return * <span class="number">100</span>, <span class="number">2</span>)))</span><br></pre></td></tr></table></figure>

<pre><code>最初收盘价为 99.98，当前收盘价为 2978.8784
持有到目前为止的收益率为 2879.47%
平均每年收益率为 103.22%
年化收益率为 12.94%</code></pre><p>看到这里，可能小伙伴们都张大了嘴大喊：“这不可能！我不相信！”是的，12.9% 的年化复利，的确很夸张。但这并不是表明指数收益相当可观，这其中的原因是：</p>
<ol>
<li>指数刚上市的时候净值很低；</li>
<li>中国的经济已经发生了天翻地覆的变化；</li>
<li>持有的时间相对长；</li>
<li>没有考虑通货膨胀与金钱的时间价值。</li>
</ol>
<p><strong>现在我们已经知道，指数从长期来看是持续向上发展的，而在指数投资中，越早投资获得的收益越好。但对于大部分的式蒺族来说，大家的理财理念并没有得到较好的普及，况且投资是一项需要承担较高风险的活动，许多工薪族朋友只能看着自己的钱包在非理性消费与通货膨胀的影响下不断的缩水。有些拥有比较好的习惯的工薪族会将部分收入储蓄到银行卡中，但仍旧逃不过金钱被贬值的命运！</strong></p>
<p><strong>其实，工薪族如果了解“定投”这个概念的话，是可以将一部分的资金从银行卡里拿出来定期存到指数投资产品中的。如果去百度定投的概念，那么会出现一些关键字，比如“低估值”，“风险平摊”，“定期定额度”，“微笑曲线”等，如果对于定投不太了解，可以先去百度一下定投的理念。</strong></p>
<p>接下来，我们构建一个以定期定额方式投资指数的模型，看看最终的投资效果如何。</p>
<p><strong>模型描述：</strong></p>
<ol>
<li>最早日期选定在上证指数公布的那一天；</li>
<li>每月的第一个交易日买入上证指数1000元；</li>
<li>假设指数的净值已经缩小到个位数,即 1000 元可以正常交易；</li>
<li>持有到现在，没有卖出。</li>
</ol>
<p>本模型不考虑交易费用与滑点，默认每次的投入本金都可以全部买进！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取每个月的第一个交易日的数据</span></span><br><span class="line">first_day = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(df)):</span><br><span class="line">    date = df.index[i]</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        first_day.append(date)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        last_date = df.index[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> date.day &lt; last_date.day:</span><br><span class="line">            first_day.append(date)</span><br><span class="line">            </span><br><span class="line">index_df = df.loc[first_day]</span><br><span class="line">index_df.index</span><br></pre></td></tr></table></figure>




<pre><code>DatetimeIndex([&apos;1990-12-19&apos;, &apos;1991-01-02&apos;, &apos;1991-02-01&apos;, &apos;1991-03-01&apos;,
               &apos;1991-04-01&apos;, &apos;1991-05-02&apos;, &apos;1991-06-03&apos;, &apos;1991-07-01&apos;,
               &apos;1991-08-01&apos;, &apos;1991-09-02&apos;,
               ...
               &apos;2018-09-03&apos;, &apos;2018-10-08&apos;, &apos;2018-11-01&apos;, &apos;2018-12-03&apos;,
               &apos;2019-01-02&apos;, &apos;2019-02-01&apos;, &apos;2019-03-01&apos;, &apos;2019-04-01&apos;,
               &apos;2019-05-06&apos;, &apos;2019-06-03&apos;],
              dtype=&apos;datetime64[ns]&apos;, length=343, freq=None)</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按照模型进行定投</span></span><br><span class="line">month_df = index_df.copy()</span><br><span class="line">month_df[<span class="string">'pct_change'</span>] = month_df[<span class="string">'close'</span>].pct_change()</span><br><span class="line">month_df = month_df[[<span class="string">'close'</span>, <span class="string">'pct_change'</span>]]  <span class="comment"># 按月整合数据</span></span><br><span class="line"></span><br><span class="line">save_money = []</span><br><span class="line">hold_money = []</span><br><span class="line">save_base = <span class="number">1000</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(month_df)):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        save_money.append(save_base)</span><br><span class="line">        hold_money.append(save_base)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        save_money.append(save_money[<span class="number">-1</span>] + save_base)</span><br><span class="line">        hold_money.append(hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + month_df[<span class="string">'pct_change'</span>][i]) + save_base)</span><br><span class="line"></span><br><span class="line">month_df[<span class="string">'save_money'</span>] = save_money</span><br><span class="line">month_df[<span class="string">'hold_money'</span>] = hold_money</span><br><span class="line">month_df.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}</code></pre><p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>pct_change</th>
      <th>save_money</th>
      <th>hold_money</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1990-12-19</th>
      <td>99.98</td>
      <td>NaN</td>
      <td>1000</td>
      <td>1000.000000</td>
    </tr>
    <tr>
      <th>1991-01-02</th>
      <td>128.84</td>
      <td>0.288658</td>
      <td>2000</td>
      <td>2288.657732</td>
    </tr>
    <tr>
      <th>1991-02-01</th>
      <td>129.51</td>
      <td>0.005200</td>
      <td>3000</td>
      <td>3300.559320</td>
    </tr>
    <tr>
      <th>1991-03-01</th>
      <td>132.53</td>
      <td>0.023319</td>
      <td>4000</td>
      <td>4377.523950</td>
    </tr>
    <tr>
      <th>1991-04-01</th>
      <td>120.73</td>
      <td>-0.089036</td>
      <td>5000</td>
      <td>4987.764781</td>
    </tr>
    <tr>
      <th>1991-05-02</th>
      <td>113.16</td>
      <td>-0.062702</td>
      <td>6000</td>
      <td>5675.022468</td>
    </tr>
    <tr>
      <th>1991-06-03</th>
      <td>115.97</td>
      <td>0.024832</td>
      <td>7000</td>
      <td>6815.945172</td>
    </tr>
    <tr>
      <th>1991-07-01</th>
      <td>136.85</td>
      <td>0.180047</td>
      <td>8000</td>
      <td>9043.132679</td>
    </tr>
    <tr>
      <th>1991-08-01</th>
      <td>145.24</td>
      <td>0.061308</td>
      <td>9000</td>
      <td>10597.549071</td>
    </tr>
    <tr>
      <th>1991-09-02</th>
      <td>180.22</td>
      <td>0.240843</td>
      <td>10000</td>
      <td>14149.891858</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算定投、收益曲线</span></span><br><span class="line">month_df[<span class="string">'return_money'</span>] = month_df[<span class="string">'hold_money'</span>] - month_df[<span class="string">'save_money'</span>]</span><br><span class="line">month_df[[<span class="string">'save_money'</span>, <span class="string">'hold_money'</span>, <span class="string">'return_money'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">plt.legend([<span class="string">'累积投入'</span>, <span class="string">'累积本息'</span>, <span class="string">'累积收入'</span>])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'累计投入: &#123;&#125;元'</span>.format(month_df[<span class="string">'save_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'累计收益: &#123;&#125;元'</span>.format(month_df[<span class="string">'return_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'最终本息累积: &#123;&#125;元'</span>.format(month_df[<span class="string">'hold_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'绝对收益率为: &#123;&#125;%'</span>.format((month_df[<span class="string">'return_money'</span>][<span class="number">-1</span>] / month_df[<span class="string">'save_money'</span>][<span class="number">-1</span>]) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_14_0.png" alt=""></p>
<pre><code>累计投入: 343000元
累计收益: 583956.3789768222元
最终本息累积: 926956.3789768222元
绝对收益率为: 170.24967317108522%</code></pre><h2 id="三、指数分析，知已知彼"><a href="#三、指数分析，知已知彼" class="headerlink" title="三、指数分析，知已知彼"></a>三、指数分析，知已知彼</h2><p>从上面的模型可以看出，如果尽早的定投，并且在低估的时候开始定投，随着国家的发展，指数的不断攀升，累积的总体收益也是一直在上升的。虽然总体收益率不是很高，但在2015的时候，总资金曾达到<strong>160万</strong>左右。</p>
<p>由于此模型没有卖出，因此在牛市疯狂的时候，没有到盈利落实到口袋中，而在市场最高的位置，也在不断的投入资金，这样便将定投的平均成本摊高了。</p>
<p>因此，接下来我们想解决的问题是，能否在指数位置偏低的时候持续定投，而在指数位置走到某种高度以上时持续卖出呢？那用什么指标来评判指数的高低位置呢？</p>
<p>了解点价值投资者的朋友，都应该听说过 <strong>PE 和 PB</strong>，它们可以用来评估标的价格是处于低估还是高估位置。因此，下面我们将 PE 和 PB 运用到指数上来，看看能否带来效果。</p>
<p>下面使用简单的中位数方式，求取指数每天的PE与PB。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从聚宽获取上证指数的信息</span></span><br><span class="line">index = <span class="string">'000001.XSHG'</span>  <span class="comment"># 指数 code</span></span><br><span class="line">index_info = get_security_info(index)  <span class="comment"># 指数信息</span></span><br><span class="line">start_date = index_info.start_date  <span class="comment"># 指数开始时间</span></span><br><span class="line">end_date = datetime.datetime.now().date()  <span class="comment"># 以当天为最后一天</span></span><br><span class="line">index_name = index_info.display_name  <span class="comment"># 指数全称</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个函数，计算每天的成份股的平均pe/pb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pe_pb</span><span class="params">(index_code, start_date, end_date)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">iter_pe_pb</span><span class="params">()</span>:</span></span><br><span class="line">        <span class="comment"># 一个获取PE/PB的生成器</span></span><br><span class="line">        trade_date = get_trade_days(start_date=start_date, end_date=end_date)   </span><br><span class="line">        <span class="keyword">for</span> date <span class="keyword">in</span> trade_date:</span><br><span class="line">            stocks = get_index_stocks(index_code, date)</span><br><span class="line">            q = query(valuation.pe_ratio, </span><br><span class="line">                      valuation.pb_ratio</span><br><span class="line">                     ).filter(valuation.pe_ratio != <span class="literal">None</span>,</span><br><span class="line">                              valuation.pb_ratio != <span class="literal">None</span>,</span><br><span class="line">                              valuation.code.in_(stocks))</span><br><span class="line">            df = get_fundamentals(q, date)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 通过分位值进行过滤异常值</span></span><br><span class="line">            <span class="comment"># 这里并没有采用三倍标准差来去除极值，差异不大</span></span><br><span class="line">            quantile = df.quantile([<span class="number">0.25</span>, <span class="number">0.75</span>])</span><br><span class="line">            df_pe = df.pe_ratio[(df.pe_ratio &gt; quantile.pe_ratio.values[<span class="number">0</span>]) &amp;\</span><br><span class="line">                                (df.pe_ratio &lt; quantile.pe_ratio.values[<span class="number">1</span>])]</span><br><span class="line">            df_pb = df.pb_ratio[(df.pb_ratio &gt; quantile.pb_ratio.values[<span class="number">0</span>]) &amp;\</span><br><span class="line">                                (df.pb_ratio &lt; quantile.pb_ratio.values[<span class="number">1</span>])]</span><br><span class="line">            <span class="keyword">yield</span> date, df_pe.median(), df_pb.median()</span><br><span class="line"></span><br><span class="line">    dict_result = [&#123;<span class="string">'date'</span>: value[<span class="number">0</span>], <span class="string">'pe'</span>: value[<span class="number">1</span>], <span class="string">'pb'</span>:value[<span class="number">2</span>]&#125; <span class="keyword">for</span> value <span class="keyword">in</span> iter_pe_pb()]</span><br><span class="line">    df_result = pd.DataFrame(dict_result)</span><br><span class="line">    df_result.set_index(<span class="string">'date'</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> df_result</span><br><span class="line"></span><br><span class="line">df_pe_pb = get_pe_pb(index, start_date, end_date)</span><br><span class="line">df_pe_pb.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}</code></pre><p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pb</th>
      <th>pe</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-01-04</th>
      <td>2.01585</td>
      <td>26.53715</td>
    </tr>
    <tr>
      <th>2005-01-05</th>
      <td>2.04450</td>
      <td>26.94350</td>
    </tr>
    <tr>
      <th>2005-01-06</th>
      <td>2.02165</td>
      <td>26.61115</td>
    </tr>
    <tr>
      <th>2005-01-07</th>
      <td>2.02360</td>
      <td>26.77050</td>
    </tr>
    <tr>
      <th>2005-01-10</th>
      <td>2.04630</td>
      <td>26.94320</td>
    </tr>
    <tr>
      <th>2005-01-11</th>
      <td>2.05100</td>
      <td>26.99430</td>
    </tr>
    <tr>
      <th>2005-01-12</th>
      <td>2.04245</td>
      <td>26.78615</td>
    </tr>
    <tr>
      <th>2005-01-13</th>
      <td>2.06330</td>
      <td>26.81250</td>
    </tr>
    <tr>
      <th>2005-01-14</th>
      <td>2.02760</td>
      <td>26.63980</td>
    </tr>
    <tr>
      <th>2005-01-17</th>
      <td>1.96960</td>
      <td>25.85190</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可视化PE/PB曲线图</span></span><br><span class="line">df_pe_pb.plot(figsize=(<span class="number">14</span>, <span class="number">7</span>), subplots=<span class="literal">True</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_17_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将PE/PB趋势与指数趋势一起展示，以作观察</span></span><br><span class="line">_, axs = plt.subplots(ncols=<span class="number">2</span>, figsize=(<span class="number">14</span>, <span class="number">5</span>))</span><br><span class="line">close = get_price(index, start_date=start_date, end_date=end_date).close</span><br><span class="line">_df = pd.DataFrame()</span><br><span class="line">_df[<span class="string">'close'</span>] = close</span><br><span class="line">_df[<span class="string">'pe'</span>] = df_pe_pb.pe</span><br><span class="line">_df[<span class="string">'pb'</span>] = df_pe_pb.pb</span><br><span class="line">_df[[<span class="string">'close'</span>, <span class="string">'pe'</span>]].plot(secondary_y=[<span class="string">'pe'</span>], ax=axs[<span class="number">0</span>], alpha=<span class="number">.8</span>)</span><br><span class="line">_df[[<span class="string">'close'</span>, <span class="string">'pb'</span>]].plot(secondary_y=[<span class="string">'pb'</span>], ax=axs[<span class="number">1</span>], alpha=<span class="number">.8</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_18_0.png" alt=""></p>
<p>如上图所示，可以看出，PE 与 PB 的大小会随着市场的起伏而呈现正相关性的波动。PE 的波动区间大概在 10 到 70 倍之间，而 PB 的波动范围大概在 0 到 7 之间。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分析PE/PB数据分布情况</span></span><br><span class="line">_, axs = plt.subplots(nrows=<span class="number">2</span>, ncols=<span class="number">2</span>, figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">sns.distplot(df_pe_pb.pe, ax=axs[<span class="number">0</span>][<span class="number">0</span>])</span><br><span class="line">sns.boxplot(df_pe_pb.pe, ax=axs[<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">sns.distplot(df_pe_pb.pb, ax=axs[<span class="number">1</span>][<span class="number">0</span>])</span><br><span class="line">sns.boxplot(df_pe_pb.pb, ax=axs[<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_20_0.png" alt=""></p>
<p>这里，通过上图的正态分布图与箱线图可以看出，PE 与 PB 有两个峰值，PE 的值主要集中在 24<del>39 倍区间，PB 的值主要集中在 2.1</del>3.6 倍之间。</p>
<p>另外，牛市顶时对就的 PE 与 PB 值数量相当少，并且与中间区间的值的距离相对比较远，以至于在箱线图上成为了离群点。通过这一点可以说明牛市顶一闪而过，时间非常短，产生的数据量也非常少。</p>
<p>整体来说，上图反应了中国股市熊长牛短的特点。因此，想要抓住牛市的机会，是需要而心等待的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 观察PE/PB之间的关系</span></span><br><span class="line">sns.jointplot(x=<span class="string">'pb'</span>,y=<span class="string">'pe'</span>, data=df_pe_pb, height=<span class="number">7</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_22_0.png" alt=""></p>
<p>PE 与 PB 都可以用来对指数进行估值，那到底用哪个比较好呢？</p>
<p>但通过上图的散点图发现，本研究对应的 PE 与 PB 数据存在线性相关的数据，也就是说这两个指标大致上是同步涨同步跌的，因此，无论用 PE 还是 PB 来进行估值，效果都差不多，因此，接下将使用 PE 进行高位位置的判断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将PE分成十个分位，查看各分位PE数量</span></span><br><span class="line">pe_array = df_pe_pb.pe.values</span><br><span class="line">value_counts = pd.cut(pe_array, <span class="number">10</span>).value_counts()</span><br><span class="line">print(value_counts)</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">14</span>, <span class="number">4</span>))</span><br><span class="line">sns.barplot(x=np.arange(<span class="number">0</span>, len(value_counts)), </span><br><span class="line">            y=value_counts.values)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<pre><code>(15.708, 21.447]     248
(21.447, 27.129]    1170
(27.129, 32.811]     523
(32.811, 38.492]     757
(38.492, 44.174]     490
(44.174, 49.856]     118
(49.856, 55.538]     100
(55.538, 61.219]     103
(61.219, 66.901]      25
(66.901, 72.583]      12
dtype: int64</code></pre><p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_24_1.png" alt=""></p>
<p>上图是将 PE 的值分成了 10 个分位，对每个分位 PE 的数量进行统计，可是以发现：</p>
<ol>
<li>第 2 个柱体是最高的，说明第 2 个 10 分位的 PE 数据量最多。</li>
<li>整体上来看，柱状图呈左偏形态，说明 PE 长时间处于 5 分位以下。</li>
<li>第 9 与第 10 个柱体代表的量少得可怜，说明高估值区的时间非常短。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 刻画PE整体趋势的中等分位区间（40%~60%）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_quantile</span><span class="params">()</span>:</span></span><br><span class="line">    _df = pd.DataFrame()</span><br><span class="line">    df = df_pe_pb.copy()</span><br><span class="line">    df.index.name = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    _df[<span class="string">'pe'</span>] = df.pe</span><br><span class="line">    _df = _df</span><br><span class="line">    p_high = [_df.pe.quantile(i / <span class="number">10.0</span>) <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]] </span><br><span class="line">    <span class="keyword">for</span> p_h, i <span class="keyword">in</span> zip(p_high, [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]):</span><br><span class="line">        _df[str(i / <span class="number">10</span> * <span class="number">100</span>)+<span class="string">'%'</span>] = p_h</span><br><span class="line"></span><br><span class="line">    low_p = _df[_df.pe &lt; _df.pe.iloc[<span class="number">-1</span>]]</span><br><span class="line">    quantile_now = low_p.shape[<span class="number">0</span>] / _df.shape[<span class="number">0</span>]  <span class="comment"># 当前百分位值</span></span><br><span class="line">    last_p = _df.pe[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">    _df.plot(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">show_quantile()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_26_0.png" alt=""></p>
<p>上图将当前 PE 按时间序列进行可视化，并用三条线标出了 40%、50%、60% 分位的位置。再结合上面的统计，可以得出：</p>
<ul>
<li>低估区的数据数量为：2686</li>
<li>估值适中区的数据数量为：608</li>
<li>高估区的数据数量为：240</li>
</ul>
<p><strong>比值为 2684:608:240</strong>。<strong>低估区间的时间是高估区时间的11.19倍。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算比值</span></span><br><span class="line">low = value_counts[<span class="number">0</span>:<span class="number">4</span>].sum()</span><br><span class="line">medin = value_counts[<span class="number">4</span>:<span class="number">6</span>].sum()</span><br><span class="line">high = value_counts[<span class="number">6</span>:<span class="number">10</span>].sum()</span><br><span class="line">print(<span class="string">'比值(&#123;&#125;：&#123;&#125;：&#123;&#125;)'</span>.format(low, medin, high))</span><br></pre></td></tr></table></figure>

<pre><code>比值(2698：608：240)</code></pre><h2 id="四、模型构思，循序渐进"><a href="#四、模型构思，循序渐进" class="headerlink" title="四、模型构思，循序渐进"></a>四、模型构思，循序渐进</h2><p>由于PE/PB数据是从聚宽数据而来，最早的时间是2005年的数据，因此，相较于1990年的数据来说，数据量减少了不止一点。但不影响接下来的研究。</p>
<p>通过上面的分析，接下来提出的设想是：设定一个可参考的估值区，当小于该估值时，进行定投，反之则持续卖出。</p>
<p>上面我们已经计算出，PE 40 到 60 的估值范围为 32.811 ~ 49.856 之间，这里我们设定此区间为适中估值区间。</p>
<p>模型的描述如下：</p>
<ol>
<li>当 PE 处于适中估值区间时，不做任何操作；当月准备的定投金归入回收资金中。</li>
<li>当 PE 低于适中估值区间时，持续定投。</li>
<li>当 PE 高于适中估值区间时，持续卖出；卖出的金额与当月准备的定投金归入回收资金中。</li>
</ol>
<p>本模型不考虑交易费用与滑点，默认每次的投入本金都可以全部买进！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取每个月的第一个交易日</span></span><br><span class="line">first_day = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(df_pe_pb)):</span><br><span class="line">    date = df_pe_pb.index[i]</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        first_day.append(date)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        last_date = df_pe_pb.index[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> date.day &lt; last_date.day:</span><br><span class="line">            first_day.append(date)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按月计算价格与涨跌幅度</span></span><br><span class="line">close = get_price(index, start_date=df_pe_pb.index[<span class="number">0</span>], end_date=df_pe_pb.index[<span class="number">-1</span>])[<span class="string">'close'</span>]</span><br><span class="line">df = df_pe_pb.copy()</span><br><span class="line">df[<span class="string">'close'</span>] = close</span><br><span class="line">df = df.loc[first_day]</span><br><span class="line">df[<span class="string">'pct_change'</span>] = df.close.pct_change()</span><br><span class="line">df.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}</code></pre><p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pb</th>
      <th>pe</th>
      <th>close</th>
      <th>pct_change</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-01-04</th>
      <td>2.01585</td>
      <td>26.53715</td>
      <td>1242.77</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2005-02-01</th>
      <td>1.86520</td>
      <td>24.02880</td>
      <td>1188.93</td>
      <td>-0.043323</td>
    </tr>
    <tr>
      <th>2005-03-01</th>
      <td>2.09300</td>
      <td>26.67730</td>
      <td>1303.41</td>
      <td>0.096288</td>
    </tr>
    <tr>
      <th>2005-04-01</th>
      <td>1.86500</td>
      <td>25.19810</td>
      <td>1223.57</td>
      <td>-0.061255</td>
    </tr>
    <tr>
      <th>2005-05-09</th>
      <td>1.59800</td>
      <td>22.17390</td>
      <td>1130.84</td>
      <td>-0.075786</td>
    </tr>
    <tr>
      <th>2005-06-01</th>
      <td>1.57390</td>
      <td>20.97550</td>
      <td>1039.19</td>
      <td>-0.081046</td>
    </tr>
    <tr>
      <th>2005-07-01</th>
      <td>1.55790</td>
      <td>21.28340</td>
      <td>1055.59</td>
      <td>0.015782</td>
    </tr>
    <tr>
      <th>2005-08-01</th>
      <td>1.49010</td>
      <td>20.81670</td>
      <td>1088.95</td>
      <td>0.031603</td>
    </tr>
    <tr>
      <th>2005-09-01</th>
      <td>1.71190</td>
      <td>22.38690</td>
      <td>1184.93</td>
      <td>0.088140</td>
    </tr>
    <tr>
      <th>2005-10-10</th>
      <td>1.69390</td>
      <td>22.21185</td>
      <td>1138.95</td>
      <td>-0.038804</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">miden_estimation = (<span class="number">38.492</span>, <span class="number">49.856</span>)  <span class="comment"># 中等估值的pe区间</span></span><br><span class="line">save_money = []  <span class="comment"># 每月定存</span></span><br><span class="line">back_money = []  <span class="comment"># 回收资金</span></span><br><span class="line">hold_money = []  <span class="comment"># 持仓资金</span></span><br><span class="line">base_money = <span class="number">1000</span>  <span class="comment"># 定投基准</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trade</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df)):</span><br><span class="line">        pe = df[<span class="string">'pe'</span>][i]  <span class="comment"># 估值位</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:  <span class="comment"># 初始买入</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            save_money.append(base_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            back_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            hold_money.append(base_money)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pe &lt;= miden_estimation[<span class="number">0</span>]:  <span class="comment"># 执行买入计算</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            save_money.append(base_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            back_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            hold_money.append(hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i]) + base_money)</span><br><span class="line">        <span class="keyword">elif</span> pe &gt;= miden_estimation[<span class="number">-1</span>]:  <span class="comment"># 执行卖出计算 </span></span><br><span class="line">            <span class="comment"># 1. 计算买入金额</span></span><br><span class="line">            save_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            back_money.append(base_money)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            hold_money.append(hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i]) - base_money)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            save_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            back_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            hold_money.append(hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i]))</span><br><span class="line">trade()</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">'save_money'</span>] = save_money  <span class="comment"># 定投金额</span></span><br><span class="line">df[<span class="string">'save_money_cumsum'</span>] = df[<span class="string">'save_money'</span>].cumsum()  <span class="comment"># 定投累计金额</span></span><br><span class="line">df[<span class="string">'hold_money'</span>] = hold_money  <span class="comment"># 持仓金额</span></span><br><span class="line">df[<span class="string">'back_money'</span>] = back_money  <span class="comment"># 回收金额</span></span><br><span class="line">df[<span class="string">'back_money_cumsum'</span>] = df[<span class="string">'back_money'</span>].cumsum()  <span class="comment"># 累计回收金额</span></span><br><span class="line">df[<span class="string">'total_money'</span>] = df[<span class="string">'hold_money'</span>] + df[<span class="string">'back_money_cumsum'</span>]  <span class="comment"># 总资金</span></span><br><span class="line">df[<span class="string">'return_money'</span>] = df[<span class="string">'total_money'</span>] - df[<span class="string">'save_money_cumsum'</span>]  <span class="comment"># 持续收益</span></span><br><span class="line">df[<span class="string">'return_rate'</span>] = (df[<span class="string">'total_money'</span>] / df[<span class="string">'save_money_cumsum'</span>]) - <span class="number">1</span>  <span class="comment"># 持续收益率</span></span><br><span class="line">df[[<span class="string">'save_money_cumsum'</span>, <span class="string">'total_money'</span>, <span class="string">'back_money_cumsum'</span>, <span class="string">'return_money'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">plt.legend([<span class="string">'累积定投'</span>, <span class="string">'累计本息'</span>, <span class="string">'回收资金'</span>, <span class="string">'收益曲线'</span>])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'累计投入: &#123;&#125;元'</span>.format(df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'累计收益: &#123;&#125;元'</span>.format(df[<span class="string">'return_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'最终本息累积: &#123;&#125;元'</span>.format(df[<span class="string">'total_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'绝对收益率为: &#123;&#125;%'</span>.format((df[<span class="string">'return_money'</span>][<span class="number">-1</span>] / df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_33_0.png" alt=""></p>
<pre><code>累计投入: 133000元
累计收益: 49155.86259384008元
最终本息累积: 182155.86259384008元
绝对收益率为: 36.95929518333841%</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年投入金额</span></span><br><span class="line">money_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    <span class="keyword">if</span> year <span class="keyword">in</span> money_year.keys():</span><br><span class="line">        money_year[year] = money_year[year] + df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        money_year[year] = df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">        </span><br><span class="line">money_mean = mean(list(money_year.values()))</span><br><span class="line">years_count = len(money_year) - <span class="number">1</span></span><br><span class="line">money_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> money_year.items()&#125;</span><br><span class="line"></span><br><span class="line">df_money_year = pd.DataFrame(money_year, index=[<span class="string">''</span>])</span><br><span class="line">df_money_year = df_money_year.T</span><br><span class="line">df_money_year.plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.hlines(money_mean, <span class="number">0</span>, years_count, color=<span class="string">'orange'</span>)</span><br><span class="line">plt.legend([<span class="string">'年均投入'</span>, <span class="string">'定投年金'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_34_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年的收益</span></span><br><span class="line">return_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    return_year[year] = df.loc[date, <span class="string">'return_rate'</span>]</span><br><span class="line">return_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> return_year.items()&#125;</span><br><span class="line">return_df = pd.DataFrame(return_year, index=[<span class="string">'return'</span>]).T</span><br><span class="line">return_df[<span class="string">'diff'</span>] = return_df[<span class="string">'return'</span>].diff()</span><br><span class="line">return_df[<span class="string">'diff'</span>].fillna(return_df[<span class="string">'return'</span>], inplace=<span class="literal">True</span>)</span><br><span class="line">return_df[[<span class="string">'diff'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.legend([<span class="string">'各年收益率'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_35_0.png" alt=""></p>
<p>从上面的模型来看，整个投资区间，回收资金过少，即不能很好的在市场上涨的时候将钱落袋为安。</p>
<p>由于买入与卖出都是按一个基准来操作的，因此，这里设想，是否可以越跌则买的越多，而越涨越卖出得越多呢？</p>
<p>模拟描述：</p>
<ol>
<li>当 PE 处于适中估值区间时，不做任何操作；当月准备的定投金归入回收资金中。</li>
<li>当 PE 低于适中估值区间时，持续定投；每低一个10%分位，则增加一倍倍投入。</li>
<li>当 PE 高于适中估值区间时，每高一个10%分位，则增加一倍卖出。在上面分析过程中发现低估值区间是高估值区间的11倍左右，因此，这里还在卖出的原倍数上乘以11.</li>
</ol>
<p>本模型不考虑交易费用与滑点，默认每次的投入本金都可以全部买进！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取每个月的第一个交易日</span></span><br><span class="line">first_day = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(df_pe_pb)):</span><br><span class="line">    date = df_pe_pb.index[i]</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        first_day.append(date)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        last_date = df_pe_pb.index[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> date.day &lt; last_date.day:</span><br><span class="line">            first_day.append(date)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按月计算价格与涨跌幅度</span></span><br><span class="line">close = get_price(index, start_date=df_pe_pb.index[<span class="number">0</span>], end_date=df_pe_pb.index[<span class="number">-1</span>])[<span class="string">'close'</span>]</span><br><span class="line">df = df_pe_pb.copy()</span><br><span class="line">df[<span class="string">'close'</span>] = close</span><br><span class="line">df = df.loc[first_day]</span><br><span class="line">df[<span class="string">'pct_change'</span>] = df.close.pct_change()</span><br><span class="line">df.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}</code></pre><p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pb</th>
      <th>pe</th>
      <th>close</th>
      <th>pct_change</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-01-04</th>
      <td>2.01585</td>
      <td>26.53715</td>
      <td>1242.77</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2005-02-01</th>
      <td>1.86520</td>
      <td>24.02880</td>
      <td>1188.93</td>
      <td>-0.043323</td>
    </tr>
    <tr>
      <th>2005-03-01</th>
      <td>2.09300</td>
      <td>26.67730</td>
      <td>1303.41</td>
      <td>0.096288</td>
    </tr>
    <tr>
      <th>2005-04-01</th>
      <td>1.86500</td>
      <td>25.19810</td>
      <td>1223.57</td>
      <td>-0.061255</td>
    </tr>
    <tr>
      <th>2005-05-09</th>
      <td>1.59800</td>
      <td>22.17390</td>
      <td>1130.84</td>
      <td>-0.075786</td>
    </tr>
    <tr>
      <th>2005-06-01</th>
      <td>1.57390</td>
      <td>20.97550</td>
      <td>1039.19</td>
      <td>-0.081046</td>
    </tr>
    <tr>
      <th>2005-07-01</th>
      <td>1.55790</td>
      <td>21.28340</td>
      <td>1055.59</td>
      <td>0.015782</td>
    </tr>
    <tr>
      <th>2005-08-01</th>
      <td>1.49010</td>
      <td>20.81670</td>
      <td>1088.95</td>
      <td>0.031603</td>
    </tr>
    <tr>
      <th>2005-09-01</th>
      <td>1.71190</td>
      <td>22.38690</td>
      <td>1184.93</td>
      <td>0.088140</td>
    </tr>
    <tr>
      <th>2005-10-10</th>
      <td>1.69390</td>
      <td>22.21185</td>
      <td>1138.95</td>
      <td>-0.038804</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_how_value</span><span class="params">(pe)</span>:</span></span><br><span class="line">    how_value = [<span class="number">15.708</span>,<span class="number">21.447</span>,<span class="number">27.129</span>,<span class="number">32.811</span>,<span class="number">38.492</span>,<span class="number">44.174</span>,</span><br><span class="line">                <span class="number">49.856</span>,<span class="number">55.538</span>,<span class="number">61.219</span>,<span class="number">66.901</span>,<span class="number">72.583</span>]</span><br><span class="line">    <span class="keyword">for</span> i, value <span class="keyword">in</span> zip(range(<span class="number">0</span>, len(how_value)) , how_value):</span><br><span class="line">        <span class="comment"># zip 包装了整数倍的分位值与对应的pe值区间</span></span><br><span class="line">        <span class="keyword">if</span> how_value[i] &lt;= pe &lt; how_value[i + <span class="number">1</span>]:</span><br><span class="line">            location = i + <span class="number">1</span></span><br><span class="line">            _how_value = <span class="number">5</span> - location  <span class="comment"># 以5为中等值</span></span><br><span class="line">            <span class="keyword">return</span> _how_value  <span class="comment"># 返回基于中位的买入或卖出倍数</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">miden_estimation = (<span class="number">38.492</span>, <span class="number">49.856</span>)  <span class="comment"># 中等估值的pe区间</span></span><br><span class="line">save_money = []  <span class="comment"># 每月定存</span></span><br><span class="line">back_money = []  <span class="comment"># 回收资金</span></span><br><span class="line">hold_money = []  <span class="comment"># 持仓资金</span></span><br><span class="line">base_money = <span class="number">1000</span>  <span class="comment"># 定投基准</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trade</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df)):</span><br><span class="line">        pe = df[<span class="string">'pe'</span>][i]  <span class="comment"># 估值位</span></span><br><span class="line">        how_value = get_how_value(pe)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:  <span class="comment"># 初始买入</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            save_money.append(base_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            back_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            hold_money.append(base_money)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> how_value &gt; <span class="number">0</span>:  <span class="comment"># 执行买入计算</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            save_money.append(base_money * how_value)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            back_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            hold_money.append(hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i]) + base_money * how_value)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 执行卖出计算 </span></span><br><span class="line">            <span class="comment"># 1. 计算买入金额</span></span><br><span class="line">            save_money.append(<span class="number">0</span>)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            back_money.append(base_money * -how_value * <span class="number">11</span>)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            hold_money.append(hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i]) - base_money * -how_value * <span class="number">11</span>)</span><br><span class="line">trade()</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">'save_money'</span>] = save_money  <span class="comment"># 定投金额</span></span><br><span class="line">df[<span class="string">'save_money_cumsum'</span>] = df[<span class="string">'save_money'</span>].cumsum()  <span class="comment"># 定投累计金额</span></span><br><span class="line">df[<span class="string">'hold_money'</span>] = hold_money  <span class="comment"># 持仓金额</span></span><br><span class="line">df[<span class="string">'back_money'</span>] = back_money  <span class="comment"># 回收金额</span></span><br><span class="line">df[<span class="string">'back_money_cumsum'</span>] = df[<span class="string">'back_money'</span>].cumsum()  <span class="comment"># 累计回收金额</span></span><br><span class="line">df[<span class="string">'total_money'</span>] = df[<span class="string">'hold_money'</span>] + df[<span class="string">'back_money_cumsum'</span>]  <span class="comment"># 总资金</span></span><br><span class="line">df[<span class="string">'return_money'</span>] = df[<span class="string">'total_money'</span>] - df[<span class="string">'save_money_cumsum'</span>]  <span class="comment"># 持续收益</span></span><br><span class="line">df[<span class="string">'return_rate'</span>] = (df[<span class="string">'total_money'</span>] / df[<span class="string">'save_money_cumsum'</span>]) - <span class="number">1</span>  <span class="comment"># 持续收益率</span></span><br><span class="line">df[[<span class="string">'save_money_cumsum'</span>, <span class="string">'total_money'</span>, <span class="string">'back_money_cumsum'</span>, <span class="string">'return_money'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">plt.legend([<span class="string">'累积定投'</span>, <span class="string">'累计本息'</span>, <span class="string">'回收资金'</span>, <span class="string">'收益曲线'</span>])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'累计投入: &#123;&#125;元'</span>.format(df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'累计收益: &#123;&#125;元'</span>.format(df[<span class="string">'return_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'最终本息累积: &#123;&#125;元'</span>.format(df[<span class="string">'total_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'绝对收益率为: &#123;&#125;%'</span>.format((df[<span class="string">'return_money'</span>][<span class="number">-1</span>] / df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_40_0.png" alt=""></p>
<pre><code>累计投入: 319000元
累计收益: 288684.23619299044元
最终本息累积: 607684.2361929904元
绝对收益率为: 90.49662576582772%</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年投入金额</span></span><br><span class="line">money_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    <span class="keyword">if</span> year <span class="keyword">in</span> money_year.keys():</span><br><span class="line">        money_year[year] = money_year[year] + df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        money_year[year] = df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">        </span><br><span class="line">money_mean = mean(list(money_year.values()))</span><br><span class="line">years_count = len(money_year) - <span class="number">1</span></span><br><span class="line">money_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> money_year.items()&#125;</span><br><span class="line"></span><br><span class="line">df_money_year = pd.DataFrame(money_year, index=[<span class="string">''</span>])</span><br><span class="line">df_money_year = df_money_year.T</span><br><span class="line">df_money_year.plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.hlines(money_mean, <span class="number">0</span>, years_count, color=<span class="string">'orange'</span>)</span><br><span class="line">plt.legend([<span class="string">'年均投入'</span>, <span class="string">'定投年金'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_41_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年的收益</span></span><br><span class="line">return_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    return_year[year] = df.loc[date, <span class="string">'return_rate'</span>]</span><br><span class="line">return_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> return_year.items()&#125;</span><br><span class="line">return_df = pd.DataFrame(return_year, index=[<span class="string">'return'</span>]).T</span><br><span class="line">return_df[<span class="string">'diff'</span>] = return_df[<span class="string">'return'</span>].diff()</span><br><span class="line">return_df[<span class="string">'diff'</span>].fillna(return_df[<span class="string">'return'</span>], inplace=<span class="literal">True</span>)</span><br><span class="line">return_df[[<span class="string">'diff'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.legend([<span class="string">'各年收益率'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_42_0.png" alt=""></p>
<p>模型有了很大的进步，总体说来，资金的增长主要靠的是持续的定投与高位的加倍卖出举动。</p>
<p>但该模型在使用了从过支到当下计算的估值区间，我们期望可以使用一种动态追踪的估值数字，来指导我们做定投。</p>
<p>设想：将表态的pe按照近一段时间，来评估当下pe占过去历史百分位的高度，此区间随着时间的移动，一来可以发生动态变化，二来可以不受太旧历史数据的影响。</p>
<p>那这个历史区间设置多久呢？在上面的计算中，我们发现一个牛熊的运动大概在7.5年左右。因此，我们在这里设置这个时间区间为7.5年。</p>
<p>来看看依照此方式计算出的结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看动态pe形态的分位趋势图</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_quantile</span><span class="params">(index_code, p, n, data)</span>:</span></span><br><span class="line">    <span class="string">"""指数百分位展示。</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        index_code: 指数 code。</span></span><br><span class="line"><span class="string">        p: 可以是 pe，也可以是 pb。</span></span><br><span class="line"><span class="string">        n: 指用于计算指数估值百分位的区间，如果是5指近5年数据。</span></span><br><span class="line"><span class="string">        data: 包含有 pe/pb 的 DataFrame。</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        计算后的DataFrame。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 这里的计算按一年244个交易日计算</span></span><br><span class="line">    windows = int(n * <span class="number">244</span>)  <span class="comment"># 将时间取整数</span></span><br><span class="line">    _df = data.copy()</span><br><span class="line">    _df.index.name = <span class="literal">None</span></span><br><span class="line">    price = get_price(index_code, start_date=_df.index[<span class="number">0</span>], end_date=_df.index[<span class="number">-1</span>])</span><br><span class="line">    _df[<span class="string">'close'</span>] = price.close</span><br><span class="line">    _df[<span class="string">'quantile'</span>] = _df[p].rolling(windows).apply(<span class="keyword">lambda</span> x: pd.Series(x).rank().iloc[<span class="number">-1</span>] / </span><br><span class="line">                                                  pd.Series(x).shape[<span class="number">0</span>], raw=<span class="literal">True</span>)</span><br><span class="line">    _df.dropna(inplace=<span class="literal">True</span>)</span><br><span class="line">    _df[<span class="string">'quantile'</span>].plot(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">    <span class="comment"># 画出适中估值区间</span></span><br><span class="line">    plt.fill_between(_df.index, y1=<span class="number">0.4</span>, y2=<span class="number">0.6</span>, color=<span class="string">'orange'</span>, alpha=<span class="number">0.7</span>)</span><br><span class="line">    plt.annotate(<span class="string">'适中估值区'</span>, (_df.index[<span class="number">-1</span>], <span class="number">0.5</span>))</span><br><span class="line">    <span class="keyword">return</span> _df</span><br><span class="line"><span class="comment"># 展示指数百分位趋势图</span></span><br><span class="line">df_quantile = get_quantile(index, <span class="string">'pe'</span>, <span class="number">7.45</span>, df_pe_pb)</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_44_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pe动态分位图与指数高低位的比较</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_quantile</span><span class="params">(index_code, p, n, data)</span>:</span></span><br><span class="line">    <span class="string">"""指数百分位展示。</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        index_code: 指数 code。</span></span><br><span class="line"><span class="string">        p: 可以是 pe，也可以是 pb。</span></span><br><span class="line"><span class="string">        n: 指用于计算指数估值百分位的区间，如果是5指近5年数据。</span></span><br><span class="line"><span class="string">        data: 包含有 pe/pb 的 DataFrame。</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        None.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># 这里的计算按一年244个交易日计算</span></span><br><span class="line">    windows = int(n * <span class="number">244</span>)  <span class="comment"># 将时间取整数</span></span><br><span class="line">    _df = data.copy()</span><br><span class="line">    _df.index.name = <span class="literal">None</span></span><br><span class="line">    price = get_price(index_code, start_date=_df.index[<span class="number">0</span>], end_date=_df.index[<span class="number">-1</span>])</span><br><span class="line">    _df[<span class="string">'close'</span>] = price.close</span><br><span class="line">    _df[<span class="string">'quantile'</span>] = _df[p].rolling(windows).apply(<span class="keyword">lambda</span> x: pd.Series(x).rank().iloc[<span class="number">-1</span>] / </span><br><span class="line">                                                  pd.Series(x).shape[<span class="number">0</span>], raw=<span class="literal">True</span>)</span><br><span class="line">    _df.dropna(inplace=<span class="literal">True</span>)</span><br><span class="line">    _df[[<span class="string">'quantile'</span>, <span class="string">'close'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">10</span>), subplots=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 画出适中估值区间</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 展示指数百分位趋势图</span></span><br><span class="line">show_quantile(index, <span class="string">'pe'</span>, <span class="number">7.5</span>, df_pe_pb)</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_45_0.png" alt=""></p>
<p>由上我们可以看出，pe近7.5年的动态分位图可以比较恰当的描述指数的高低起伏。</p>
<p>由此作出以下模型构思。</p>
<p>模型描述：</p>
<ol>
<li>以近7.5年的pe分位来指导定投操作；</li>
<li>当分位值低于适中估值区间时，按倍增法买入；</li>
<li>当分位值处于适中估值区间时，不做任何操作；</li>
<li>当分位值高于适中估值区间时，按照立方指数数倍卖出。</li>
</ol>
<p>本模型不考虑交易费用与滑点，默认每次的投入本金都可以全部买进！</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取每个月的第一个交易日</span></span><br><span class="line">first_day = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(df_quantile)):</span><br><span class="line">    date = df_quantile.index[i]</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        first_day.append(date)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        last_date = df_quantile.index[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> date.day &lt; last_date.day:</span><br><span class="line">            first_day.append(date)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按月计算价格与涨跌幅度</span></span><br><span class="line">close = get_price(index, start_date=df_quantile.index[<span class="number">0</span>], end_date=df_quantile.index[<span class="number">-1</span>])[<span class="string">'close'</span>]</span><br><span class="line">df = df_quantile.copy()</span><br><span class="line">df[<span class="string">'close'</span>] = close</span><br><span class="line">df = df.loc[first_day]</span><br><span class="line">df[<span class="string">'pct_change'</span>] = df.close.pct_change()</span><br><span class="line">df.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}</code></pre><p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pb</th>
      <th>pe</th>
      <th>close</th>
      <th>quantile</th>
      <th>pct_change</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2012-06-28</th>
      <td>2.34595</td>
      <td>23.62375</td>
      <td>2195.84</td>
      <td>0.201431</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2012-07-02</th>
      <td>2.41665</td>
      <td>24.12060</td>
      <td>2226.11</td>
      <td>0.215190</td>
      <td>0.013785</td>
    </tr>
    <tr>
      <th>2012-08-01</th>
      <td>2.23125</td>
      <td>22.63260</td>
      <td>2123.36</td>
      <td>0.165107</td>
      <td>-0.046157</td>
    </tr>
    <tr>
      <th>2012-09-03</th>
      <td>2.17690</td>
      <td>21.89940</td>
      <td>2059.15</td>
      <td>0.114474</td>
      <td>-0.030240</td>
    </tr>
    <tr>
      <th>2012-10-08</th>
      <td>2.20460</td>
      <td>21.38255</td>
      <td>2074.42</td>
      <td>0.088608</td>
      <td>0.007416</td>
    </tr>
    <tr>
      <th>2012-11-01</th>
      <td>2.16470</td>
      <td>21.78270</td>
      <td>2104.43</td>
      <td>0.116676</td>
      <td>0.014467</td>
    </tr>
    <tr>
      <th>2012-12-03</th>
      <td>1.82780</td>
      <td>18.31150</td>
      <td>1959.77</td>
      <td>0.010457</td>
      <td>-0.068741</td>
    </tr>
    <tr>
      <th>2013-01-04</th>
      <td>2.17510</td>
      <td>21.58100</td>
      <td>2276.99</td>
      <td>0.112273</td>
      <td>0.161866</td>
    </tr>
    <tr>
      <th>2013-02-01</th>
      <td>2.34590</td>
      <td>23.32070</td>
      <td>2419.02</td>
      <td>0.219042</td>
      <td>0.062376</td>
    </tr>
    <tr>
      <th>2013-03-01</th>
      <td>2.40170</td>
      <td>24.69880</td>
      <td>2359.51</td>
      <td>0.270226</td>
      <td>-0.024601</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">save_money = []  <span class="comment"># 每月定存</span></span><br><span class="line">back_money = []  <span class="comment"># 回收资金</span></span><br><span class="line">hold_money = []  <span class="comment"># 持仓资金</span></span><br><span class="line">base_money = <span class="number">1000</span>  <span class="comment"># 定投基准</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trade</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df)):</span><br><span class="line">        quantile = df[<span class="string">'quantile'</span>][i]  <span class="comment"># 估值位</span></span><br><span class="line">        multiple = int((<span class="number">0.5</span> - quantile) * <span class="number">10</span>)  <span class="comment"># 定投倍数计算</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:  <span class="comment"># 初始买入</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            _save_money = base_money * multiple</span><br><span class="line">            save_money.append(_save_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            _back_money = <span class="number">0</span></span><br><span class="line">            back_money.append(_back_money)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            _hold_money = _save_money</span><br><span class="line">            hold_money.append(_hold_money)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> multiple &gt;=<span class="number">0</span>:  <span class="comment"># 执行买入计算</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            _save_money = base_money * multiple</span><br><span class="line">            save_money.append(_save_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            _back_money = <span class="number">0</span></span><br><span class="line">            back_money.append(_back_money)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            _hold_money = hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i]) + _save_money</span><br><span class="line">            hold_money.append(_hold_money)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 执行卖出计算 </span></span><br><span class="line">            <span class="comment"># 1. 计算买入金额</span></span><br><span class="line">            _save_money = <span class="number">0</span></span><br><span class="line">            save_money.append(_save_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            _back_money = base_money * (<span class="number">2</span> ** -multiple)  <span class="comment"># 按2的指数倍卖出</span></span><br><span class="line">            _hold_money = hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i])</span><br><span class="line">            <span class="keyword">if</span> _back_money &gt; _hold_money:</span><br><span class="line">                _back_money = _hold_money</span><br><span class="line">            <span class="keyword">if</span> quantile &gt;= <span class="number">1.0</span>:</span><br><span class="line">                _back_money = _hold_money  <span class="comment"># 如果达到100%分位，清仓</span></span><br><span class="line">            back_money.append(_back_money)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            _hold_money = _hold_money - _back_money</span><br><span class="line">            hold_money.append(_hold_money)</span><br><span class="line">trade()</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">'save_money'</span>] = save_money  <span class="comment"># 定投金额</span></span><br><span class="line">df[<span class="string">'save_money_cumsum'</span>] = df[<span class="string">'save_money'</span>].cumsum()  <span class="comment"># 定投累计金额</span></span><br><span class="line">df[<span class="string">'hold_money'</span>] = hold_money  <span class="comment"># 持仓金额</span></span><br><span class="line">df[<span class="string">'back_money'</span>] = back_money  <span class="comment"># 回收金额</span></span><br><span class="line">df[<span class="string">'back_money_cumsum'</span>] = df[<span class="string">'back_money'</span>].cumsum()  <span class="comment"># 累计回收金额</span></span><br><span class="line">df[<span class="string">'total_money'</span>] = df[<span class="string">'hold_money'</span>] + df[<span class="string">'back_money_cumsum'</span>]  <span class="comment"># 总资金</span></span><br><span class="line">df[<span class="string">'return_money'</span>] = df[<span class="string">'total_money'</span>] - df[<span class="string">'save_money_cumsum'</span>]  <span class="comment"># 持续收益</span></span><br><span class="line">df[<span class="string">'return_rate'</span>] = (df[<span class="string">'total_money'</span>] / df[<span class="string">'save_money_cumsum'</span>]) - <span class="number">1</span>  <span class="comment"># 持续收益率</span></span><br><span class="line">df[[<span class="string">'save_money_cumsum'</span>, <span class="string">'total_money'</span>, <span class="string">'back_money_cumsum'</span>, <span class="string">'return_money'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">plt.legend([<span class="string">'累积定投'</span>, <span class="string">'累计本息'</span>, <span class="string">'回收资金'</span>, <span class="string">'收益曲线'</span>])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'累计投入: &#123;&#125;元'</span>.format(df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'累计收益: &#123;&#125;元'</span>.format(df[<span class="string">'return_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'最终本息累积: &#123;&#125;元'</span>.format(df[<span class="string">'total_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'绝对收益率为: &#123;&#125;%'</span>.format((df[<span class="string">'return_money'</span>][<span class="number">-1</span>] / df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_49_0.png" alt=""></p>
<pre><code>累计投入: 99000元
累计收益: 77142.48573219407元
最终本息累积: 176142.48573219407元
绝对收益率为: 77.92170275979198%</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年投入金额</span></span><br><span class="line">money_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    <span class="keyword">if</span> year <span class="keyword">in</span> money_year.keys():</span><br><span class="line">        money_year[year] = money_year[year] + df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        money_year[year] = df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">        </span><br><span class="line">money_mean = mean(list(money_year.values()))</span><br><span class="line">years_count = len(money_year) - <span class="number">1</span></span><br><span class="line">money_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> money_year.items()&#125;</span><br><span class="line"></span><br><span class="line">df_money_year = pd.DataFrame(money_year, index=[<span class="string">''</span>])</span><br><span class="line">df_money_year = df_money_year.T</span><br><span class="line">df_money_year.plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.hlines(money_mean, <span class="number">0</span>, years_count, color=<span class="string">'orange'</span>)</span><br><span class="line">plt.legend([<span class="string">'年均投入'</span>, <span class="string">'定投年金'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_50_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年的收益</span></span><br><span class="line">return_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    return_year[year] = df.loc[date, <span class="string">'return_rate'</span>]</span><br><span class="line">return_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> return_year.items()&#125;</span><br><span class="line">return_df = pd.DataFrame(return_year, index=[<span class="string">'return'</span>]).T</span><br><span class="line">return_df[<span class="string">'diff'</span>] = return_df[<span class="string">'return'</span>].diff()</span><br><span class="line">return_df[<span class="string">'diff'</span>].fillna(return_df[<span class="string">'return'</span>], inplace=<span class="literal">True</span>)</span><br><span class="line">return_df[[<span class="string">'diff'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.legend([<span class="string">'各年收益率'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_51_0.png" alt=""></p>
<p>由于采用了动态计算pe百分位高度的方式，又牺牲掉了7.5年时间的数据，因此这个模型的数据更少。</p>
<p>但通过观察，发现整体的收益很可观，再结果文章开始对于下个牛市的展望，我们可以期望在2021年左右，获得一次资产翻倍的机会。</p>
<p>另外，在定投的过程中，可以将加收的资金买入国债，以增加收益，如果经过了多轮牛熊后，更可以将回收的资金再次投入的下一次的定投中去，以达成在低估值区间买入更多份额的目标。</p>
<p>由于篇幅有限，这两种情况就不作演算了。</p>
<p>最后说一点，由于该模型是在历史几个牛熊数据上推理优化而得，因此，这是一个过拟合模型。但为何还要去研究呢？是因为，这一切都建立在指数有效的假设上。即：我们相信，中国的运势会越来越好，指数有低谷，也终将有高潮！</p>
<p><strong>接下来，我们将上面的模型尝试运用到沪深300指数上，检验一下效果。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">index = <span class="string">'000300.XSHG'</span>  <span class="comment"># 指数 code</span></span><br><span class="line">index_info = get_security_info(index)  <span class="comment"># 指数信息</span></span><br><span class="line">start_date = index_info.start_date  <span class="comment"># 指数开始时间</span></span><br><span class="line">end_date = datetime.datetime.now().date()  <span class="comment"># 以当天为最后一天</span></span><br><span class="line">index_name = index_info.display_name  <span class="comment"># 指数全称</span></span><br><span class="line"></span><br><span class="line">df_pe_pb = get_pe_pb(index, start_date, end_date)</span><br><span class="line">df_pe_pb.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}</code></pre><p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pb</th>
      <th>pe</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2005-04-08</th>
      <td>1.95560</td>
      <td>20.30690</td>
    </tr>
    <tr>
      <th>2005-04-11</th>
      <td>1.95630</td>
      <td>20.27660</td>
    </tr>
    <tr>
      <th>2005-04-12</th>
      <td>1.89530</td>
      <td>19.94685</td>
    </tr>
    <tr>
      <th>2005-04-13</th>
      <td>1.95555</td>
      <td>20.39210</td>
    </tr>
    <tr>
      <th>2005-04-14</th>
      <td>1.93260</td>
      <td>19.93285</td>
    </tr>
    <tr>
      <th>2005-04-15</th>
      <td>1.89060</td>
      <td>19.65655</td>
    </tr>
    <tr>
      <th>2005-04-18</th>
      <td>1.88145</td>
      <td>19.49545</td>
    </tr>
    <tr>
      <th>2005-04-19</th>
      <td>1.89960</td>
      <td>19.96190</td>
    </tr>
    <tr>
      <th>2005-04-20</th>
      <td>1.83585</td>
      <td>19.86055</td>
    </tr>
    <tr>
      <th>2005-04-21</th>
      <td>1.80415</td>
      <td>19.57075</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示指数百分位趋势图</span></span><br><span class="line">df_quantile = get_quantile(index, <span class="string">'pe'</span>, <span class="number">7.45</span>, df_pe_pb)</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_54_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示指数百分位趋势图</span></span><br><span class="line">show_quantile(index, <span class="string">'pe'</span>, <span class="number">7.45</span>, df_pe_pb)</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_55_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取每个月的第一个交易日</span></span><br><span class="line">first_day = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(df_quantile)):</span><br><span class="line">    date = df_quantile.index[i]</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        first_day.append(date)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        last_date = df_quantile.index[i - <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> date.day &lt; last_date.day:</span><br><span class="line">            first_day.append(date)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按月计算价格与涨跌幅度</span></span><br><span class="line">close = get_price(index, start_date=df_quantile.index[<span class="number">0</span>], end_date=df_quantile.index[<span class="number">-1</span>])[<span class="string">'close'</span>]</span><br><span class="line">df = df_quantile.copy()</span><br><span class="line">df[<span class="string">'close'</span>] = close</span><br><span class="line">df = df.loc[first_day]</span><br><span class="line">df[<span class="string">'pct_change'</span>] = df.close.pct_change()</span><br><span class="line">df.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}</code></pre><p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pb</th>
      <th>pe</th>
      <th>close</th>
      <th>quantile</th>
      <th>pct_change</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2012-09-21</th>
      <td>1.93745</td>
      <td>17.02400</td>
      <td>2199.06</td>
      <td>0.106769</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2012-10-08</th>
      <td>1.98520</td>
      <td>17.63935</td>
      <td>2270.05</td>
      <td>0.135113</td>
      <td>0.032282</td>
    </tr>
    <tr>
      <th>2012-11-01</th>
      <td>1.93975</td>
      <td>18.08920</td>
      <td>2297.88</td>
      <td>0.177766</td>
      <td>0.012260</td>
    </tr>
    <tr>
      <th>2012-12-03</th>
      <td>1.66340</td>
      <td>15.75390</td>
      <td>2108.85</td>
      <td>0.040726</td>
      <td>-0.082263</td>
    </tr>
    <tr>
      <th>2013-01-04</th>
      <td>2.10385</td>
      <td>18.96275</td>
      <td>2524.41</td>
      <td>0.261970</td>
      <td>0.197055</td>
    </tr>
    <tr>
      <th>2013-02-01</th>
      <td>2.22630</td>
      <td>20.12825</td>
      <td>2743.32</td>
      <td>0.329114</td>
      <td>0.086717</td>
    </tr>
    <tr>
      <th>2013-03-01</th>
      <td>2.20090</td>
      <td>20.36475</td>
      <td>2668.84</td>
      <td>0.344524</td>
      <td>-0.027150</td>
    </tr>
    <tr>
      <th>2013-04-01</th>
      <td>1.98140</td>
      <td>18.83550</td>
      <td>2493.19</td>
      <td>0.238305</td>
      <td>-0.065815</td>
    </tr>
    <tr>
      <th>2013-05-02</th>
      <td>1.87415</td>
      <td>17.33815</td>
      <td>2449.64</td>
      <td>0.114474</td>
      <td>-0.017468</td>
    </tr>
    <tr>
      <th>2013-06-03</th>
      <td>2.00610</td>
      <td>18.97265</td>
      <td>2602.62</td>
      <td>0.238855</td>
      <td>0.062450</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">save_money = []  <span class="comment"># 每月定存</span></span><br><span class="line">back_money = []  <span class="comment"># 回收资金</span></span><br><span class="line">hold_money = []  <span class="comment"># 持仓资金</span></span><br><span class="line">base_money = <span class="number">1000</span>  <span class="comment"># 定投基准</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trade</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(df)):</span><br><span class="line">        quantile = df[<span class="string">'quantile'</span>][i]  <span class="comment"># 估值位</span></span><br><span class="line">        multiple = int((<span class="number">0.5</span> - quantile) * <span class="number">10</span>)  <span class="comment"># 定投倍数计算</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:  <span class="comment"># 初始买入</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            _save_money = base_money * multiple</span><br><span class="line">            save_money.append(_save_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            _back_money = <span class="number">0</span></span><br><span class="line">            back_money.append(_back_money)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            _hold_money = _save_money</span><br><span class="line">            hold_money.append(_hold_money)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> multiple &gt;=<span class="number">0</span>:  <span class="comment"># 执行买入计算</span></span><br><span class="line">            <span class="comment"># 1.计算买入金额</span></span><br><span class="line">            _save_money = base_money * multiple</span><br><span class="line">            save_money.append(_save_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            _back_money = <span class="number">0</span></span><br><span class="line">            back_money.append(_back_money)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            _hold_money = hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i]) + _save_money</span><br><span class="line">            hold_money.append(_hold_money)</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># 执行卖出计算 </span></span><br><span class="line">            <span class="comment"># 1. 计算买入金额</span></span><br><span class="line">            _save_money = <span class="number">0</span></span><br><span class="line">            save_money.append(_save_money)</span><br><span class="line">            <span class="comment"># 2. 计算回收金额</span></span><br><span class="line">            _back_money = base_money * (<span class="number">2</span> ** -multiple)  <span class="comment"># 按2的指数倍卖出</span></span><br><span class="line">            _hold_money = hold_money[<span class="number">-1</span>] * (<span class="number">1</span> + df[<span class="string">'pct_change'</span>][i])</span><br><span class="line">            <span class="keyword">if</span> _back_money &gt; _hold_money:</span><br><span class="line">                _back_money = _hold_money</span><br><span class="line">            <span class="keyword">if</span> quantile &gt;= <span class="number">1.0</span>:</span><br><span class="line">                _back_money = _hold_money  <span class="comment"># 如果达到100%分位，清仓</span></span><br><span class="line">            back_money.append(_back_money)</span><br><span class="line">            <span class="comment"># 3. 计算持仓变化</span></span><br><span class="line">            _hold_money = _hold_money - _back_money</span><br><span class="line">            hold_money.append(_hold_money)</span><br><span class="line">trade()</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="string">'save_money'</span>] = save_money  <span class="comment"># 定投金额</span></span><br><span class="line">df[<span class="string">'save_money_cumsum'</span>] = df[<span class="string">'save_money'</span>].cumsum()  <span class="comment"># 定投累计金额</span></span><br><span class="line">df[<span class="string">'hold_money'</span>] = hold_money  <span class="comment"># 持仓金额</span></span><br><span class="line">df[<span class="string">'back_money'</span>] = back_money  <span class="comment"># 回收金额</span></span><br><span class="line">df[<span class="string">'back_money_cumsum'</span>] = df[<span class="string">'back_money'</span>].cumsum()  <span class="comment"># 累计回收金额</span></span><br><span class="line">df[<span class="string">'total_money'</span>] = df[<span class="string">'hold_money'</span>] + df[<span class="string">'back_money_cumsum'</span>]  <span class="comment"># 总资金</span></span><br><span class="line">df[<span class="string">'return_money'</span>] = df[<span class="string">'total_money'</span>] - df[<span class="string">'save_money_cumsum'</span>]  <span class="comment"># 持续收益</span></span><br><span class="line">df[<span class="string">'return_rate'</span>] = (df[<span class="string">'total_money'</span>] / df[<span class="string">'save_money_cumsum'</span>]) - <span class="number">1</span>  <span class="comment"># 持续收益率</span></span><br><span class="line">df[[<span class="string">'save_money_cumsum'</span>, <span class="string">'total_money'</span>, <span class="string">'back_money_cumsum'</span>, <span class="string">'return_money'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">7</span>))</span><br><span class="line">plt.legend([<span class="string">'累积定投'</span>, <span class="string">'累计本息'</span>, <span class="string">'回收资金'</span>, <span class="string">'收益曲线'</span>])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">print(<span class="string">'累计投入: &#123;&#125;元'</span>.format(df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'累计收益: &#123;&#125;元'</span>.format(df[<span class="string">'return_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'最终本息累积: &#123;&#125;元'</span>.format(df[<span class="string">'total_money'</span>][<span class="number">-1</span>]))</span><br><span class="line">print(<span class="string">'绝对收益率为: &#123;&#125;%'</span>.format((df[<span class="string">'return_money'</span>][<span class="number">-1</span>] / df[<span class="string">'save_money_cumsum'</span>][<span class="number">-1</span>]) * <span class="number">100</span>))</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_58_0.png" alt=""></p>
<pre><code>累计投入: 89000元
累计收益: 49339.34427308533元
最终本息累积: 138339.34427308533元
绝对收益率为: 55.43746547537677%</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年投入金额</span></span><br><span class="line">money_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    <span class="keyword">if</span> year <span class="keyword">in</span> money_year.keys():</span><br><span class="line">        money_year[year] = money_year[year] + df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        money_year[year] = df.loc[date, <span class="string">'save_money'</span>]</span><br><span class="line">        </span><br><span class="line">money_mean = mean(list(money_year.values()))</span><br><span class="line">years_count = len(money_year) - <span class="number">1</span></span><br><span class="line">money_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> money_year.items()&#125;</span><br><span class="line"></span><br><span class="line">df_money_year = pd.DataFrame(money_year, index=[<span class="string">''</span>])</span><br><span class="line">df_money_year = df_money_year.T</span><br><span class="line">df_money_year.plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.hlines(money_mean, <span class="number">0</span>, years_count, color=<span class="string">'orange'</span>)</span><br><span class="line">plt.legend([<span class="string">'年均投入'</span>, <span class="string">'定投年金'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_59_0.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 展示各年的收益</span></span><br><span class="line">return_year = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> df.index:</span><br><span class="line">    year = date.year</span><br><span class="line">    return_year[year] = df.loc[date, <span class="string">'return_rate'</span>]</span><br><span class="line">return_year = &#123;key: [value] <span class="keyword">for</span> key, value <span class="keyword">in</span> return_year.items()&#125;</span><br><span class="line">return_df = pd.DataFrame(return_year, index=[<span class="string">'return'</span>]).T</span><br><span class="line">return_df[<span class="string">'diff'</span>] = return_df[<span class="string">'return'</span>].diff()</span><br><span class="line">return_df[<span class="string">'diff'</span>].fillna(return_df[<span class="string">'return'</span>], inplace=<span class="literal">True</span>)</span><br><span class="line">return_df[[<span class="string">'diff'</span>]].plot(figsize=(<span class="number">14</span>, <span class="number">4</span>), kind=<span class="string">'bar'</span>)</span><br><span class="line">plt.legend([<span class="string">'各年收益率'</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/lhdt_output_60_0.png" alt=""></p>
<p>通过以上的模型，我们可以观察到，一个牛熊的时间，投入的资产可以约摸翻一倍。根据72法则（72 / 年化利率 = 资产翻倍时间），得出 <strong>72 / 7.5年 = 9.6%</strong>,即，我们可以期望通过定投实现年化9.6%的年化复利效果。</p>
<p>作为朝九晚五甚至是996的工薪族来说，这无疑是一个振奋人心的消息。由于没有足够的时间关心投资市场的情况，也没有足够的知识去创建高频的交易模型，通过量化定投，可以每月看一次市场估值，根据百分位而选择适当的金额投入，一来强制自己每月储蓄，二来在时间横向发展过程中，渐渐的壮大资金，7.5年对工薪族来说，是一个恰当而合适的机会！</p>
<p>定投并不是没有风险的，在投资过程中，就像上图一样，有某些年份是要亏损的，但只要做到耐心等待，合理分投，不盲目跟风，一定会迎一份属于你的惊喜！</p>
<p><strong>致天下所有奋斗者！</strong></p>

          
            <div class='article_footer'>
              
                
  
    
    



  

  
    
    



  

  

  


              
            </div>
          
        </div>
        
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2020-05-05T10:23:21+08:00">
  <a class='notlink'>
    <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
    <p>更新于：May 5, 2020</p>
  </a>
</div>

        
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E9%87%8F%E5%8C%96/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>量化</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/python/" rel="nofollow"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i><p>python</p></a></div>


        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=www.hicoder.com.cn/2020/05/04/%E9%87%8F%E5%8C%96%E5%AE%9A%E6%8A%95%EF%BC%8C%E5%B7%A5%E8%96%AA%E6%97%8F%E9%80%86%E8%A2%AD%E4%B9%8B%E8%B7%AF/&title=量化定投，工薪族逆袭之路 - HiCoder&pics=https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/thumbnail_line_chart.ico&summary=

一个人一生能积累多少钱，不是取决于他能够赚多少钱，而是取决于他如何投资理财，人找钱不如钱找钱，要知道让钱为你工作，而不是你为钱工作。——（美）沃伦●巴菲特
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=www.hicoder.com.cn/2020/05/04/%E9%87%8F%E5%8C%96%E5%AE%9A%E6%8A%95%EF%BC%8C%E5%B7%A5%E8%96%AA%E6%97%8F%E9%80%86%E8%A2%AD%E4%B9%8B%E8%B7%AF/&title=量化定投，工薪族逆袭之路 - HiCoder&pics=https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/thumbnail_line_chart.ico&summary=

一个人一生能积累多少钱，不是取决于他能够赚多少钱，而是取决于他如何投资理财，人找钱不如钱找钱，要知道让钱为你工作，而不是你为钱工作。——（美）沃伦●巴菲特
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=www.hicoder.com.cn/2020/05/04/%E9%87%8F%E5%8C%96%E5%AE%9A%E6%8A%95%EF%BC%8C%E5%B7%A5%E8%96%AA%E6%97%8F%E9%80%86%E8%A2%AD%E4%B9%8B%E8%B7%AF/&title=量化定投，工薪族逆袭之路 - HiCoder&pics=https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/thumbnail_line_chart.ico&summary=

一个人一生能积累多少钱，不是取决于他能够赚多少钱，而是取决于他如何投资理财，人找钱不如钱找钱，要知道让钱为你工作，而不是你为钱工作。——（美）沃伦●巴菲特
"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/weibo.png">
          
        </a>
      
    
      
        
        <div class='hoverbox'>
          <a><img src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/logo/128/wechat.png"></a>
          <div class='target'>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZgAAAGYCAAAAABaUKuJAAAGDUlEQVR42u3bQU7dQBAEUO5/abIPQu6qbhOkvNkB/9sz/ZxFqZyPT+tXrg8jAGOBAWOBAWOBsR5hPsr19/e/3CC8zrcbfbjvdF/p/dPPnc0TDBgwYMCAAQMGDBgwY5hxAHrYSHudFLbdZ7vv7YM63icYMGDAgAEDBgwYMGBimOtAuQ2Q28D6U0Hyap5gwIABAwYMGDBgwIB5H2ZaZLUg24GmQe+qIAQDBgwYMGDAgAEDBszvhWkDXVtg1S/ShedMzwUGDBgwYMCAAQMGDJh/B5Pe+Cqwbb939f00QLbzAQMGDBgwYMCAAQMGzB7mOrj97z/X8wQDBgwYMCDAgAEDBswjzHa1gbENcm3AbAu7tlir5wkGDBgwYMCAAQMGDJhHmOkLd9ugefX76xf90vNdnXuc/MGAAQMGDBgwYMCAAfNtwGwD1PTzaeC7CpzTfUwHN73+WfIHAwYMGDBgwIABAwbMI0wb5N4KqG0Btw2k6YOyDb5gwIABAwYMGDBgwIDpYdoBtQPZBtqr4q0tvq4LRTBgwIABAwYMGDBgwMxhfipwtoNNH5zr4uvq+o9wYMCAAQMGDBgwYMCAGcNsD/J24GuDX1vsXb3gGP8DAAMGDBgwYMCAAQMGzCPMNhC1xdlnudLg2xZsV0VYfH8wYMCAAQMGDBgwYMCcwVwVSVv4Fizd13bVgGDAgAEDBgwYMGDAgHmEaW+QFmJpQdYO/Kr4ugrecUAHAwYMGDBgwIABAwbMGOYq4F0VYu192wIvfRDa+4MBAwYMGDBgwIABA+YOZrqxbcA8O0D4ol866Dogbl8oBAMGDBgwYMCAAQMGzCPMtHi6CnxXxVJboG3P0b4wOP4cGDBgwIABAwYMGDBg4qJsGuC2AS8dQH3QsiBrH6g0uIMBAwYMGDBgwIABAyaH2QaybRHVHmT6QFwFxG2wHp8TDBgwYMCAAQMGDBgwjzDXQXO68e0Ld23QTQNxCtLOBwwYMGDAgAEDBgwYMP17ZduBtxDXBdpVYdcWce1cwYABAwYMGDBgwIAB8wzTHmD7c/v7q+u/HYjr84IBAwYMGDBgwIABA2YM0wautqjaFlFXAXNcYL0ceMGAAQMGDBgwYMCAAbP/f/7TwW83ug2Q7WqDYnue14oyMGDAgAEDBgwYMGD+Q5hp4Lo6UFokvQ3UBs3p3+MHAgwYMGDAgAEDBgwYMGOYFCLd4Lb4agPqdnApTLt/MGDAgAEDBgwYMGDAzGHaoNUObhs0t8F1er8teFoUggEDBgwYMGDAgAEDJocZf/H4oGlB9taaQqTnjB9YMGDAgAEDBgwYMGDAjIuyNmBeFWvpwadw04C6LQLT+3x7XTBgwIABAwYMGDBgwDzCpC/mpcHqqmhLB5gCXz2g6wcDDBgwYMCAAQMGDBgwjzBXwfGqaLoKnu2DsD3/GhIMGDBgwIABAwYMGDDjPiYdzDZoXoGmcNMXDNvCrJ0fGDBgwIABAwYMGDBgcpht0dMGte0Dsg2C29+fzwEMGDBgwIABAwYMGDBxH7Mtjtqgla6nB+TqwfjxwAoGDBgwYMCAAQMGDJhHmDSgfYYrPcg0yLZFWnuu9sGIAywYMGDAgAEDBgwYMGDWMFdF1hbqCjh9wLb3jecHBgwYMGDAgAEDBgyYGKYFaAusNFimL9xtz9EWcHWhBwYMGDBgwIABAwYMmEeY9iDp368HdP2i4lXh1b64CAYMGDBgwIABAwYMmDnMdrUFVftzC/xWYN7u58t1wYABAwYMGDBgwIAB8wizDUbt59tCbTuwtNj68fOAAQMGDBgwYMCAAQNmDNMGynRQbVB7q3BrYdqA+Xg+MGDAgAEDBgwYMGDAxDBpoJoO8mlA0/tsA3B77nYfcQAGAwYMGDBgwIABAwbM6zDb4PjTn2sD6FXgfpwbGDBgwIABAwYMGDBgfh3MNmhuB5oCXwXr8XzAgAEDBgwYMGDAgAETw6SB6ipopQO6Krba67ZB9nGfYMCAAQMGDBgwYMCAGcNsX2C7Krau7nsVGLeBdB0wwYABAwYMGDBgwIAB8wXG+l0LDBgLDBgLDBgLjPXt+gM/Z3W0vdmJ/QAAAABJRU5ErkJggg==">
          </div>
        </div>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
          <div class="prev-next">
            
            
              <a class='next' href='/2020/05/04/KDJ%E6%8C%87%E6%A0%87%E5%9C%A8%E6%8C%87%E6%95%B0%E4%B8%8A%E7%9A%84%E6%8B%A9%E6%97%B6%E6%95%88%E5%BA%94/'>
                <p class='title'>KDJ指标在指数上的择时效应<i class="fas fa-chevron-right" aria-hidden="true"></i></p>
                <p class='content'>123456"""导入常用模块"""import numpy as npimport pandas as pdimport matplotlib.pyplot as pltimport date...</p>
              </a>
            
          </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box reveal comments shadow">
    <section class="article typo">
      <p ct><i class='fas fa-comments'></i> 评论</p>
      
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-cog fa-spin fa-fw fa-2x"></i>
          </div>
        </section>
      
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: '量化定投，工薪族逆袭之路',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
  

  
    
    


  <section class="widget toc-wrapper shadow desktop mobile">
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、指数格局，跌宕起伏"><span class="toc-text">一、指数格局，跌宕起伏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、定投畅想，看好国运"><span class="toc-text">二、定投畅想，看好国运</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、指数分析，知已知彼"><span class="toc-text">三、指数分析，知已知彼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、模型构思，循序渐进"><span class="toc-text">四、模型构思，循序渐进</span></a></li></ol>
    </div>
  </section>


  


</aside>


  
  <footer class="clearfix">
    <br><br>
    
      
        <div class="aplayer-container">
          

  
    <meting-js
      theme='#1BCDFC'
      autoplay='false'
      volume='0.7'
      loop='all'
      order='list'
      fixed='false'
      list-max-height='340px'
      server='netease'
      type='playlist'
      id='3175833810'
      list-folded='true'>
    </meting-js>
  


        </div>
      
    
      
        <br>
        <div class="social-wrapper">
          
            
              <a href="/atom.xml"
                class="social fas fa-rss flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="mailto:me@xaoxuu.com"
                class="social fas fa-envelope flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://github.com/xaoxuu"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
            
              <a href="https://music.163.com/#/user/home?id=63035382"
                class="social fas fa-headphones-alt flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer">
              </a>
            
          
        </div>
      
    
      
        <div><p>Blog content follows the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0) License</a></p>
</div>
      
    
      
        Use
        <a href="https://volantis.js.org/" target="_blank" class="codename">Volantis</a>
        as theme, total visits
          <span id="busuanzi_value_site_pv"><i class="fas fa-circle-notch fa-spin fa-fw" aria-hidden="true"></i></span>
          times
        
      
    
      
        <div class='copyright'>
        <p><a href="https://xaoxuu.com" target="_blank" rel="noopener">Copyright © 2017-2020 Mr. X</a></p>

        </div>
      
    
  </footer>

<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js"></script>


  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/instant_page.js" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.6/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      ScrollReveal().reveal('.l_main .reveal', {
        distance: '8px',
        duration: '800',
        interval: '100',
        scale: '1'
      });
    });
  </script>


  
<script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>

  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>



  
  
  
    
<script src="https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js"></script>

    <script type="text/javascript">
      $(function(){
        var imgs=["https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/background1.jpeg", "https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/background2.jpeg", "https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/background2.jpeg", "https://cdn.jsdelivr.net/gh/mrshiqiqi/resource/background4.jpeg"];
        if ('true' == 'true') {
          function shuffle(arr){
            /*From countercurrent-time*/
            var n = arr.length;
            while(n--) {
              var index = Math.floor(Math.random() * n);
              var temp = arr[index];
              arr[index] = arr[n];
              arr[n] = temp;
            }
          }
          shuffle(imgs);
        }
        if ('.cover') {
          $('.cover').backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        } else {
          $.backstretch(
            imgs,
          {
            duration: "20000",
            fade: "1500"
          });
        }
      });
    </script>
  



  
    
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>

  
    
<script src="https://cdn.jsdelivr.net/npm/meting@2.0/dist/Meting.min.js"></script>

  








  
    
<script src="https://cdn.jsdelivr.net/npm/valine@1.4/dist/Valine.min.js"></script>

  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var meta = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick','mail','link'];
  var requiredFields = 'nick,mail'.split(',').filter(function(item){
    return REQUIRED_FIELDS.indexOf(item) > -1
  });
  var valine = new Valine();
  function emoji(path, idx, ext) {
      return path + "/" + path + "-" + idx + "." + ext;
  }
  var emojiMaps = {};
  for (var i = 1; i <= 54; i++) {
    emojiMaps['tieba-' + i] = emoji('tieba', i, 'png');
  }
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 116; i++) {
    emojiMaps['aru-' + i] = emoji('aru', i, 'gif');
  }
  for (var i = 1; i <= 125; i++) {
    emojiMaps['twemoji-' + i] = emoji('twemoji', i, 'png');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }
  valine.init({
    el: '#valine_container',
    meta: meta,
    
    appId: "jBd0JVmKCSxJs5rmD0zbIxqU-gzGzoHsz",
    appKey: "D7yRmtaLMJr9hhHLOdBy8dhe",
    placeholder: "快来评论吧~",
    pageSize:'10',
    avatar:'robohash',
    lang:'zh-cn',
    visitor: 'true',
    highlight: 'true',
    mathJax: 'false',
    enableQQ: 'true',
    requiredFields: requiredFields,
    emojiCDN: 'https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/emoji/valine/',
    emojiMaps: emojiMaps
  })
  </script>





  
<script src="/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2.4/js/search.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@2/js/comment_typing.js"></script>






<!-- 复制 -->

  <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="fas fa-copy"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-check-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-check-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('fa-copy');
        $icon.addClass('fa-times-circle');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('fa-times-circle');
          $icon.addClass('fa-copy');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>




<!-- fancybox -->

  <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("div.fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>






  <script>setLoadingBarProgress(100);</script>
</body>
</html>
